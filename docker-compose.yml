services:
  # 1. THE DATABASE (PostgreSQL + Vector Support)
  database:
    image: pgvector/pgvector:pg16
    container_name: dnd_postgres
    environment:
      POSTGRES_USER: dm_admin
      POSTGRES_PASSWORD: ${DB_PASS:-secretpassword}
      POSTGRES_DB: dungeon_data
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Mount the init script - it will run automatically on first start
      - ./database/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    ports:
      - "5432:5432"
    networks:
      - dm_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dm_admin -d dungeon_data"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 3. THE ARTIST (Stable Diffusion) - Start before LLM
  image_gen:
    build: ./image_service
    container_name: dnd_artist
    ports:
      - "8001:8001"
    volumes:
      - shared_images:/shared/images
      - ${MODEL_CACHE_PATH:-./model_cache}/diffusers:/data/model_cache
    environment:
      - HF_HOME=/data/model_cache
      - TRANSFORMERS_CACHE=/data/model_cache
      - DIFFUSERS_CACHE=/data/model_cache
    networks:
      - dm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # 4. THE VOICE (TTS) - Start before LLM
  tts_voice:
    build: ./tts_service
    container_name: dnd_voice
    ports:
      - "8002:8002"
    volumes:
      - shared_audio:/shared/audio
      - ~/dnd_models/tts_cache:/root/.cache/huggingface
      - ~/dnd_models/reference_voices:/shared/reference_voices
    environment:
      - COQUI_TTS_CACHE=/data/tts_cache
      - TTS_CACHE=/data/tts_cache
    networks:
      - dm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # 2. THE BRAIN (Llama 3.2) - Starts after support services
  llm_brain:
    build: ./llm_service
    container_name: dnd_llm
    ports:
      - "8000:8000"
    volumes:
      - ${MODEL_CACHE_PATH:-./model_cache}/huggingface:/data/model_cache
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - HF_HOME=/data/model_cache
      - TRANSFORMERS_CACHE=/data/model_cache
      - DB_HOST=database
      - DB_NAME=dungeon_data
      - DB_USER=dm_admin
      - DB_PASS=${DB_PASS:-secretpassword}
    depends_on:
      database:
        condition: service_healthy
      image_gen:
        condition: service_healthy
      tts_voice:
        condition: service_healthy
    networks:
      - dm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 240s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # 5. DJANGO WEB APP (The Interface) - Starts last
  webapp:
    build: ./web_service
    container_name: dnd_website
    ports:
      - "8080:8000"
    volumes:
      - ./web_service:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - shared_images:/shared/images
      - shared_audio:/shared/audio
    depends_on:
      database:
        condition: service_healthy
      llm_brain:
        condition: service_healthy
    environment:
      - DB_HOST=database
      - DB_NAME=dungeon_data
      - DB_USER=dm_admin
      - DB_PASS=${DB_PASS:-secretpassword}
      - LLM_API=http://llm_brain:8000
      - IMAGE_API=http://image_gen:8001
      - TTS_API=http://tts_voice:8002
    networks:
      - dm_network

networks:
  dm_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  postgres_data:
  shared_images:
  shared_audio: